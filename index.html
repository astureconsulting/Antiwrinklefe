<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>TheHealthSpace AI Assistant</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
:root {
  --webring-yellow: #727B97;
  --webring-black: #222;
  --webring-bg: #F4F4F4;
  --webring-gray: #555;
  --user-bubble-bg: #FFF9C4;
  --bot-bubble-bg: #222;
  --bot-bubble-color: #fff;
  --border-radius: 18px;
}
html, body { height: 100%; margin: 0; }
body {
  min-height: 100vh;
  background: var(--webring-bg);
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  color: var(--webring-black);
  display: flex;
  align-items: center;
  justify-content: center;
}
.chat-container {
  background: #fff;
  box-shadow: 0 6px 24px rgba(58,93,35,0.09);
  width: 100%;
  max-width: 410px;
  height: 600px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}
.chat-header {
  background: var(--webring-yellow);
  color: var(--webring-black);
  padding: 14px 0 10px 0;
  text-align: left;
  border-bottom: 1.5px solid #fffbe5;
  font-weight: 700;
  letter-spacing: 0.5px;
  display: flex;
  align-items: center;
  position: relative;
}
.chat-header h1 {
  font-size: 20px;
  font-weight: 700;
  padding-left: 22px;
  margin: 0;
  flex: 1;
  user-select: none;
  color: white;
}
.chat-header .close {
  position: absolute;
  right: 45px;
  top: 13px;
  font-size: 23px;
  color: #666;
  background: none;
  border: none;
  cursor: pointer;
}
.chat-header .reset {
  position: absolute;
  right: 13px;
  top: 13px;
  font-size: 14px;
  padding: 6px 10px;
  border: none;
  border-radius: 14px;
  background: #444;
  color: white;
  cursor: pointer;
  user-select: none;
}
.chat-messages {
  flex: 1;
  padding: 20px 14px;
  overflow-y: auto;
  background: #fff;
  display: flex;
  flex-direction: column;
}
.message-row {
  display: flex;
  align-items: flex-end;
  margin-bottom: 8px;
}
.avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: #ddd;
  margin-right: 7px;
}
.avatar.user {
  margin-left: 7px;
  margin-right: 0;
}
.message {
  padding: 13px 18px;
  border-radius: var(--border-radius);
  max-width: 77%;
  font-size: 15px;
  word-break: break-word;
  box-shadow: 0 1px 4px rgba(34,34,34,0.06);
  line-height: 1.55;
}
.message.bot {
  background: var(--bot-bubble-bg);
  color: var(--bot-bubble-color);
  margin-right: auto;
  border-bottom-left-radius: 6px;
}
.message.user {
  background: var(--user-bubble-bg);
  color: var(--webring-black);
  margin-left: auto;
  border-bottom-right-radius: 6px;
  text-align: right;
}
.message-meta {
  font-size: 12px;
  color: #999;
  margin-top: 3px;
  margin-bottom: 0;
  padding: 0 4px;
}
.typing-indicator {
  display: none;
  padding: 9px 14px;
  margin-bottom: 10px;
  border-radius: var(--border-radius);
  background: #f8f8f8;
  border: 1px solid #eee;
  color: #888;
  margin-right: auto;
  margin-left: 0;
  font-size: 14px;
}
.typing-indicator.active {
  display: inline-block;
}
.chat-input-container {
  padding: 10px 12px;
  background: var(--bot-bubble-bg);
}
.input-group {
  display: flex;
  gap: 8px;
  align-items: flex-end;
  background: var(--bot-bubble-bg);
}
#promptInput {
  flex: 1;
  padding: 12px 16px;
  border: 1.5px solid #ececec;
  border-radius: 20px;
  font-size: 15px;
  min-height: 20px;
  max-height: 80px;
  outline: none;
  background: #f8f8f8;
  color: var(--webring-black);
  resize: none;
  transition: border 0.18s, background 0.15s;
}
#promptInput::placeholder {
  color: #979797;
}
#promptInput:focus {
  border-color: var(--webring-yellow);
  background: #fffbe5;
}
#sendButton {
  background: var(--webring-yellow);
  color: var(--webring-black);
  border: none;
  padding: 12px 19px;
  border-radius: 20px;
  cursor: pointer;
  font-size: 17px;
  font-weight: 600;
  transition: background 0.18s, color 0.18s;
  display: flex;
  align-items: center;
  box-shadow: 0 2px 8px rgba(58,93,35,0.06);
}
#sendButton:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
#sendButton:hover:not(:disabled),
#sendButton:focus:not(:disabled) {
  background: #ffec80;
  color: #111;
}
@media (max-width: 650px) {
  .chat-container { height: 100vh; border-radius: 0; max-width: 100%; }
  .message { max-width: 90vw; }
}
</style>
</head>
<body>
<div class="chat-container" role="main" aria-label="Chat container">
  <div class="chat-header" role="banner">
    <h1>TheHealthSpace AI Assistant</h1>
    <button class="close" title="Reload Page" aria-label="Reload chat window" onclick="window.location.reload()">&times;</button>
    <button class="reset" title="Reset Chat" aria-label="Reset chat history" id="resetButton">Reset Chat</button>
  </div>

  <div class="chat-messages" id="chatMessages" aria-live="polite" aria-atomic="false"></div>

  <div class="typing-indicator" id="typingIndicator" aria-live="assertive" aria-atomic="true">
    TheHealthSpace Bot is typing...
  </div>

  <div class="chat-input-container" role="form" aria-label="Chat input form">
    <div class="input-group">
      <textarea id="promptInput" rows="1" placeholder="Type your message here..." autocomplete="off" aria-label="Type your message"></textarea>
      <button id="sendButton" aria-label="Send message" title="Send message" disabled>
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true" focusable="false">
          <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>
  </div>
</div>
<script>
const API_URL = 'https://web-production-56b6.up.railway.app/chat'; // Replace with your backend URL
const BOT_AVATAR = "https://img.icons8.com/color/96/robot.png";
const USER_AVATAR = "https://img.icons8.com/ios-glyphs/60/000000/user--v1.png";

const chatMessages = document.getElementById('chatMessages');
const promptInput = document.getElementById('promptInput');
const sendButton = document.getElementById('sendButton');
const typingIndicator = document.getElementById('typingIndicator');
const resetButton = document.getElementById('resetButton');

let sessionMessages = []; // Will hold the conversation for UI persistence

// Load previous messages from sessionStorage
function loadMessagesFromStorage() {
  try {
    const saved = sessionStorage.getItem('chatMessages');
    if (saved) {
      sessionMessages = JSON.parse(saved);
      sessionMessages.forEach(msg => {
        createMessage(msg.content, msg.isUser);
      });
      scrollToBottom();
    }
  } catch {
    sessionMessages = [];
  }
}

// Save messages to sessionStorage
function saveMessagesToStorage() {
  sessionStorage.setItem('chatMessages', JSON.stringify(sessionMessages));
}

// Create and append message to chat UI
function createMessage(content, isUser = false, metaText = "") {
  const msgRow = document.createElement('div');
  msgRow.className = 'message-row';
  // Avatar
  const avatar = document.createElement('img');
  avatar.className = 'avatar' + (isUser ? ' user' : '');
  avatar.src = isUser ? USER_AVATAR : BOT_AVATAR;
  avatar.alt = isUser ? "You" : "Bot";
  avatar.loading = "lazy";
  avatar.width = 36; avatar.height = 36;

  // Message bubble
  const msgDiv = document.createElement('div');
  msgDiv.className = `message ${isUser ? 'user' : 'bot'}`;
  msgDiv.innerHTML = content.replace(/\n/g, "<br>");

  if (isUser) {
    msgRow.appendChild(msgDiv);
    msgRow.appendChild(avatar);
  } else {
    msgRow.appendChild(avatar);
    msgRow.appendChild(msgDiv);
  }

  chatMessages.appendChild(msgRow);

  // Meta (optional)
  if (metaText) {
    const meta = document.createElement('div');
    meta.className = 'message-meta';
    meta.innerText = metaText;
    msgRow.appendChild(meta);
  }

  scrollToBottom();
  return msgRow;
}

function scrollToBottom() {
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Show typing indicator
function showTyping() {
  typingIndicator.classList.add('active');
  scrollToBottom();
}
// Hide typing indicator
function hideTyping() {
  typingIndicator.classList.remove('active');
}

// Enable or disable send button based on input content
function toggleSendButton() {
  sendButton.disabled = !promptInput.value.trim().length;
}

promptInput.addEventListener('input', () => {
  // Auto-expand text area height, max 80px (about 4 lines)
  promptInput.style.height = 'auto';
  promptInput.style.height = Math.min(promptInput.scrollHeight, 80) + 'px';
  toggleSendButton();
});

promptInput.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

sendButton.addEventListener('click', sendMessage);

resetButton.addEventListener('click', () => {
  // Clear UI chat, clear storage, reload page for fresh start
  sessionStorage.removeItem('chatMessages');
  window.location.reload();
});

function disableInput() {
  promptInput.disabled = true;
  sendButton.disabled = true;
}

function enableInput() {
  promptInput.disabled = false;
  toggleSendButton();
  promptInput.focus();
}

// Send user message and fetch bot response
async function sendMessage() {
  const prompt = promptInput.value.trim();
  if (!prompt) return;

  // Display user message immediately
  createMessage(prompt, true);
  sessionMessages.push({ content: prompt, isUser: true });
  saveMessagesToStorage();

  // Clear input and disable while waiting
  promptInput.value = '';
  promptInput.style.height = 'auto';
  disableInput();
  showTyping();

  try {
    const response = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include', // to maintain cookies/session with backend
      body: JSON.stringify({ message: prompt })
    });

    if (!response.ok) {
      throw new Error(`Server error: ${response.statusText}`);
    }

    const data = await response.json();

    // Display bot message
    if (data.response) {
      createMessage(data.response, false);
      sessionMessages.push({ content: data.response, isUser: false });
      saveMessagesToStorage();
    } else if (data.error) {
      createMessage(`Error: ${data.error}`, false);
      sessionMessages.push({ content: `Error: ${data.error}`, isUser: false });
      saveMessagesToStorage();
    }

  } catch (err) {
    createMessage('Sorry, there was an error connecting to the server.', false);
    sessionMessages.push({ content: 'Sorry, there was an error connecting to the server.', isUser: false });
    saveMessagesToStorage();
  } finally {
    hideTyping();
    enableInput();
  }
}

// Initialize chat on page load
window.addEventListener('DOMContentLoaded', () => {
  // Optionally add a date/time separator on top if none exist
  if (!sessionStorage.getItem('chatMessages')) {
    const dateRow = document.createElement('div');
    dateRow.style.textAlign = "center";
    dateRow.style.margin = "10px 0 15px 0";
    dateRow.style.color = "#bbb";
    dateRow.style.fontSize = "13px";
    dateRow.innerText = new Date().toLocaleDateString(undefined, {
      weekday: 'long',
      year: 'numeric',
      month: '2-digit',
      day: '2-digit'
    });
    chatMessages.appendChild(dateRow);
  }

  loadMessagesFromStorage();
  toggleSendButton();
  promptInput.focus();
});
</script>
</body>
</html>
